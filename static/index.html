<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPT + Stockfish Chess Tutor</title>

  <!-- CDN: chessboard.js + chess.js(UMD) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <style>
    :root { --w: 440px; }
    body { font-family: -apple-system, Arial, 'Noto Sans KR', sans-serif; margin:0; padding:16px; max-width:1100px; }
    h2 { margin:0 0 8px; }
    #board { width: var(--w); max-width:92vw; margin:12px auto; border:1px solid #e5e7eb; border-radius:6px; }
    .pill { display:inline-block; background:#f4f5f7; border-radius:999px; padding:6px 10px; font-size:12px; color:#555; }
    .controls { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:8px 0 16px; }
    button, select { padding:8px 12px; font-size:14px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .panel { flex:1 1 360px; }
    textarea { width:100%; min-height:140px; }
    footer { margin-top:10px; text-align:center; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h2>♟ GPT + Stockfish Chess Tutor</h2>
  <div class="pill">말을 드래그해 수를 두고, “이 위치 분석하기”를 누르세요.</div>

  <div id="board"></div>

  <div class="controls">
    <button id="startBtn">초기화</button>
    <button id="undoBtn">되돌리기</button>
    <select id="levelSel">
      <option value="beginner" selected>설명: 초급</option>
      <option value="intermediate">설명: 중급</option>
      <option value="advanced">설명: 고급</option>
    </select>
    <button id="analyzeBtn">이 위치 분석하기</button>
  </div>

  <div class="row">
    <div class="panel">
      <h3>엔진 요약</h3>
      <textarea id="summary" readonly></textarea>
    </div>
    <div class="panel">
      <h3>GPT 해설</h3>
      <textarea id="explain" readonly></textarea>
    </div>
  </div>

  <footer>현재 FEN: <span id="fenTxt" class="pill"></span></footer>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof window.Chess !== 'function') {
        alert('chess.js 로딩 실패');
        return;
      }

      // 표시용 보드 객체 (실제 수 적용/검증은 서버가 함)
      const board = Chessboard('board', {
        position: 'start',
        draggable: true,
        onDrop: handleDrop
      });

      // FEN을 보드에 반영
      function setFen(fen) { board.position(fen); document.getElementById('fenTxt').textContent = fen; }
      setFen(Chess().fen());

      // UCI 만들기(+ 승진 q)
      function buildUci(from, to, piece) {
        // 승진 여부: 폰이 마지막 랭크로 이동할 때
        const rank = to[1];
        const isWhitePawn = piece === 'wP';
        const isBlackPawn = piece === 'bP';
        const promotion = (isWhitePawn && rank === '8') || (isBlackPawn && rank === '1') ? 'q' : '';
        return `${from}${to}${promotion}`;
      }

      // 드롭 시 서버에 /move 요청해서 합법성/새 FEN 받기
      async function handleDrop(source, target, piece) {
        if (source === target) return 'snapback';
        const uci = buildUci(source, target, piece);
        const fen = document.getElementById('fenTxt').textContent || Chess().fen();

        try {
          const res = await fetch('/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fen, uci })
          });
          const data = await res.json();
          if (!data.ok) {
            console.warn(data.error);
            return 'snapback';
          }
          setFen(data.fen);
        } catch (e) {
          console.error(e);
          return 'snapback';
        }
      }

      document.getElementById('startBtn').onclick = () => setFen(Chess().fen());
      document.getElementById('undoBtn').onclick = async () => {
        // 간단한 로컬 undo (서버 보드 상태와 불일치 방지 위해 실제 게임은 다시 구성 권장)
        alert('간단 데모에선 Undo를 지원하지 않습니다. 필요 시 서버에 move history를 추가하세요.');
      };

      async function callAnalyze(payload) {
        for (const path of ['/analyze', '/app/pgn']) {
          try {
            const r = await fetch(path, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (r.ok) return await r.json();
          } catch (e) {}
        }
        throw new Error('API 호출 실패');
      }

      document.getElementById('analyzeBtn').onclick = async () => {
        const summaryEl = document.getElementById('summary');
        const explainEl = document.getElementById('explain');
        const level = document.getElementById('levelSel').value;
        const fen = document.getElementById('fenTxt').textContent;

        summaryEl.value = '분석 중… (Stockfish 엔진 계산)';
        explainEl.value = '';

        try {
          const out = await callAnalyze({ fen, played_san: null, level, depth: 14, multipv: 3 });
          summaryEl.value = out.summary || JSON.stringify(out, null, 2);
          explainEl.value = out.explanation || '(설명 없음)';
        } catch (err) {
          summaryEl.value = '에러: ' + err.message;
          explainEl.value = '';
        }
      };
    });
  </script>
</body>
</html>
