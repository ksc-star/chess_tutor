<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPT + Stockfish Chess Tutor</title>

  <!-- 보드 UI만 로드 (로컬 파일) -->
  <link rel="stylesheet" href="vendor/chessboard-1.0.0.min.css" />
  <script src="vendor/chessboard-1.0.0.min.js"></script>

  <style>
    :root { --w: 440px; }
    body { font-family: -apple-system, Arial, 'Noto Sans KR', sans-serif; margin:0; padding:16px; max-width:1100px; }
    h2 { margin:0 0 8px; }
    #board { width: var(--w); max-width:92vw; margin:12px auto; border:1px solid #e5e7eb; border-radius:6px; }
    .pill { display:inline-block; background:#f4f5f7; border-radius:999px; padding:6px 10px; font-size:12px; color:#555; }
    .controls { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:8px 0 16px; }
    button, select { padding:8px 12px; font-size:14px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .panel { flex:1 1 360px; }
    textarea { width:100%; min-height:140px; }
    footer { margin-top:10px; text-align:center; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h2>♟ GPT + Stockfish Chess Tutor</h2>
  <div class="pill">말을 드래그해 수를 두면 서버가 합법수 판단과 FEN 갱신을 해줍니다.</div>

  <div id="board"></div>

  <div class="controls">
    <button id="startBtn">초기화</button>
    <button id="undoBtn">되돌리기</button>
    <select id="levelSel">
      <option value="beginner" selected>설명: 초급</option>
      <option value="intermediate">설명: 중급</option>
      <option value="advanced">설명: 고급</option>
    </select>
    <button id="analyzeBtn">이 위치 분석하기</button>
  </div>

  <div class="row">
    <div class="panel">
      <h3>엔진 요약</h3>
      <textarea id="summary" readonly></textarea>
    </div>
    <div class="panel">
      <h3>GPT 해설</h3>
      <textarea id="explain" readonly></textarea>
    </div>
  </div>

  <footer>현재 FEN: <span id="fenTxt" class="pill"></span></footer>

  <script>
    // 표준 시작 FEN
    const START_FEN = "rn1qkbnr/pppb1ppp/4p3/3p4/3P4/2N1PN2/PPP2PPP/R1BQKB1R b KQkq - 2 5"; // <- 원래: "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
    // 위 줄은 예시입니다. 일반 시작판 사용하려면 아래 라인을 쓰세요:
    // const START_FEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";

    let fen = START_FEN;
    const fenHistory = [fen];

    const board = Chessboard('board', {
      position: 'start',
      draggable: true,
      onDrop: async (from, to) => {
        // 프로모션 간단 처리: 기본적으로 퀸 승진
        const uci = from + to + (to[1] === '8' && from[1] === '7' ? 'q' : (to[1] === '1' && from[1] === '2' ? 'q' : ''));
        try {
          const res = await fetch('/move', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ fen, uci })
          });
          const data = await res.json();
          if (!data.ok) return 'snapback';
          fen = data.fen;
          fenHistory.push(fen);
          board.position(fen);
          refreshFen();
        } catch {
          return 'snapback';
        }
      }
    });

    function refreshFen() {
      document.getElementById('fenTxt').textContent = fen;
    }
    // 시작판 보이기
    board.start();
    refreshFen();

    document.getElementById('startBtn').onclick = () => {
      fen = START_FEN;
      fenHistory.length = 0; fenHistory.push(fen);
      board.start();
      refreshFen();
    };

    document.getElementById('undoBtn').onclick = () => {
      if (fenHistory.length <= 1) return;
      fenHistory.pop();
      fen = fenHistory[fenHistory.length - 1];
      board.position(fen);
      refreshFen();
    };

    async function callAnalyze(payload) {
      const res = await fetch('/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('API 호출 실패');
      return await res.json();
    }

    document.getElementById('analyzeBtn').onclick = async () => {
      const summaryEl = document.getElementById('summary');
      const explainEl = document.getElementById('explain');
      const level = document.getElementById('levelSel').value;

      summaryEl.value = '분석 중… (Stockfish 엔진 계산)';
      explainEl.value = '';

      try {
        const out = await callAnalyze({ fen, played_san: null, level, depth: 14, multipv: 3 });
        summaryEl.value = out.summary || JSON.stringify(out, null, 2);
        explainEl.value = out.explanation || '(설명 없음)';
      } catch (e) {
        summaryEl.value = '에러: ' + e.message;
        explainEl.value = '';
      }
    };
  </script>
</body>
</html>
