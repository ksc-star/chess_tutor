<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPT + Stockfish Chess Tutor</title>

  <!-- chessboard.js만 사용 -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

  <style>
    :root { --w: 440px; }
    body { font-family: -apple-system, Arial, 'Noto Sans KR', sans-serif; margin:0; padding:16px; max-width:1100px; }
    h2 { margin:0 0 8px; }
    #board { width: var(--w); max-width:92vw; margin:12px auto; border:1px solid #e5e7eb; border-radius:6px; }
    .pill { display:inline-block; background:#f4f5f7; border-radius:999px; padding:6px 10px; font-size:12px; color:#555; }
    .controls { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:8px 0 16px; }
    button, select { padding:8px 12px; font-size:14px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .panel { flex:1 1 360px; }
    textarea { width:100%; min-height:140px; }
    footer { margin-top:10px; text-align:center; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h2>♟ GPT + Stockfish Chess Tutor</h2>
  <div class="pill">말을 드래그해 수를 두고, “이 위치 분석하기”를 누르세요.</div>

  <div id="board"></div>

  <div class="controls">
    <button id="startBtn">초기화</button>
    <!-- chess.js를 제거했으므로 '되돌리기'는 비활성(서버 히스토리 추가 시 구현 가능) -->
    <select id="levelSel">
      <option value="beginner" selected>설명: 초급</option>
      <option value="intermediate">설명: 중급</option>
      <option value="advanced">설명: 고급</option>
    </select>
    <button id="analyzeBtn">이 위치 분석하기</button>
  </div>

  <div class="row">
    <div class="panel">
      <h3>엔진 요약</h3>
      <textarea id="summary" readonly></textarea>
    </div>
    <div class="panel">
      <h3>GPT 해설</h3>
      <textarea id="explain" readonly></textarea>
    </div>
  </div>

  <footer>현재 FEN: <span id="fenTxt" class="pill"></span></footer>

  <script>
    const START_FEN =
      "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";

    let fen = START_FEN;

    const board = Chessboard('board', {
      position: 'start',
      draggable: true,
      pieceTheme:
        'https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/img/chesspieces/wikipedia/{piece}.png',
      onDrop: async (from, to) => {
        // 1) 프로모션 없는 UCI 시도
        let r = await postMove(from + to);
        // 2) 실패하면 'q' 프로모션 UCI로 재시도(필요한 상황만 성공)
        if (!r.ok) r = await postMove(from + to + 'q');
        if (!r.ok) return 'snapback';

        fen = r.fen;
        board.position(fen);
        updateFen();
      }
    });

    function updateFen() {
      document.getElementById('fenTxt').textContent = fen;
    }
    updateFen();

    document.getElementById('startBtn').onclick = () => {
      fen = START_FEN;
      board.start();
      updateFen();
    };

    async function postMove(uci) {
      const res = await fetch('/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fen, uci })
      });
      return await res.json();
    }

    function setSummary(t) { document.getElementById('summary').value = t; }
    function setExplain(t) { document.getElementById('explain').value = t; }

    document.getElementById('analyzeBtn').onclick = async () => {
      setSummary('분석 중… (Stockfish 엔진 계산)');
      setExplain('');
      const level = document.getElementById('levelSel').value;
      try {
        const res = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fen, played_san: null, level, depth: 14, multipv: 3
          })
        });
        const out = await res.json();
        setSummary(out.summary || JSON.stringify(out, null, 2));
        setExplain(out.explanation || '(설명 없음)');
      } catch (e) {
        setSummary('에러: ' + e.message);
        setExplain('');
      }
    };
  </script>
</body>
</html>
